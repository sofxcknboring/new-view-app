from contextlib import asynccontextmanager

import api
import uvicorn
from core.config import settings
from core.models import db_helper
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

description = """
Net-View API. üöÄ

## CoreSwitch

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏:
* **–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ–ø–æ—Ä–Ω—ã–π –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä**
* **–í–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–ø–æ—Ä–Ω–æ–≥–æ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–∞ –∏ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–æ–≤**
* **–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± –æ–ø–æ—Ä–Ω–æ–º –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–µ**
* **–£–¥–∞–ª–∏—Ç—å –æ–ø–æ—Ä–Ω—ã–π –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä** (_–ù–µ —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ_)

## Switch

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏:
* **–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ–ø–æ—Ä–Ω—ã–π –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä**
* **–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä—ã –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**(_—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º_)
* **–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± –æ–ø–æ—Ä–Ω–æ–º –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–µ**
* **–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä**(_–ù–µ —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ_)

## Device
–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ READ, UPDATE –æ–ø–µ—Ä–∞—Ü–∏–∏:
* **–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
* **–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ**

## Snmp Control
–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
(_–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ API –∫–ª—é—á—É_)

<details>
<summary>## ChangeLog</summary>

### [1.0.0] - 2023-10-01
- –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è API —Å –±–∞–∑–æ–≤—ã–º–∏ CRUD –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –¥–ª—è CoreSwitch –∏ Switch.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

### [1.1.0] - 2023-10-15
- –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è Device.
- –£–ª—É—á—à–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–æ–≤.

### [1.2.0] - 2023-10-20
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SNMP –∫–æ–Ω—Ç—Ä–æ–ª—è.
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤.

</details>

"""


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è FastAPI.
    –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –Ω–∞ —ç—Ç–∞–ø–µ —Å—Ç–∞—Ä—Ç–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    Args:
        app (FastAPI): –≠–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è FastAPI.

    Yields:
        None: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏ –∑–∞–ø—É—Å–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.
    """
    # start up logic
    yield
    # shutdown logic
    await db_helper.dispose()


main_app = FastAPI(
    title="Net-View-API",
    description=description,
    contact={
        "name": "Dev contact",
        "url": "https://mattermost.neovox.ru/ncc/messages/@v.a.mishurenko",
    },
    lifespan=lifespan,
)
main_app.include_router(api.router)


origins = [
    "https://grafana.danilenko.tech",
]

main_app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

if __name__ == "__main__":
    uvicorn.run(
        "main:main_app",
        host=settings.run.host,
        port=settings.run.port,
        reload=True,
        workers=4,
        log_config="log_conf.yaml"
    )
